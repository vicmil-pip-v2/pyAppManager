<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>App Manager</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        h1, h2 { color: #333; }
        .section { margin-bottom: 30px; }
        .app, .remote-app { border: 1px solid #ccc; padding: 10px; margin-bottom: 10px; border-radius: 5px; }
        button { margin-right: 5px; padding: 5px 10px; cursor: pointer; }
        .running { color: green; font-weight: bold; }
        .stopped { color: red; font-weight: bold; }
        #system_status { margin-bottom: 20px; }
        .top-bar {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .top-bar-buttons {
            display: flex;
            gap: 10px;
        }
        .logout-btn {
            background-color: #dc3545;
            color: white;
            border: none;
            padding: 6px 12px;
            border-radius: 5px;
        }
        .logout-btn:hover {
            background-color: #b02a37;
        }
        .nginx-btn {
            background-color: #28a745;
            color: white;
            border: none;
            padding: 6px 12px;
            border-radius: 5px;
        }
        .nginx-btn:hover {
            background-color: #218838;
        }

        /* ===== SYSTEM STATUS ===== */
        .status-item {
            margin-bottom: 15px;
        }

        .progress-bar {
            width: 100%;
            height: 15px;
            background-color: #eee;
            border-radius: 5px;
            overflow: hidden;
            margin: 5px 0;
        }

        .progress-fill {
            height: 100%;
            background-color: #007bff;
            transition: width 0.4s ease;
        }

        .progress-fill.warning {
            background-color: #ffc107;
        }

        .progress-fill.danger {
            background-color: #dc3545;
        }

        .status-item small {
            display: block;
            color: #555;
            font-size: 0.9em;
        }
    </style>
</head>
<body>
    <div class="top-bar">
        <h1>App Manager Dashboard</h1>
        <div class="top-bar-buttons">
            <button class="nginx-btn" onclick="goToNginx()">NGINX</button>
            <button class="logout-btn" onclick="logout()">Logout</button>
        </div>
    </div>

    <!-- System Status -->
    <div id="system_status" class="section">
        <h2>System Status</h2>

        <div class="status-item">
            <strong>CPU Usage:</strong>
            <div class="progress-bar">
                <div id="cpu-bar" class="progress-fill" style="width: 0%;"></div>
            </div>
            <span id="cpu-text">--%</span>
        </div>

        <div class="status-item">
            <strong>Memory Usage:</strong>
            <div class="progress-bar">
                <div id="memory-bar" class="progress-fill" style="width: 0%;"></div>
            </div>
            <span id="memory-text">--%</span>
            <small id="memory-details"></small>
        </div>

        <div class="status-item">
            <strong>Storage Usage:</strong>
            <div class="progress-bar">
                <div id="storage-bar" class="progress-fill" style="width: 0%;"></div>
            </div>
            <span id="storage-text">--%</span>
            <small id="storage-details"></small>
        </div>
    </div>

    <!-- Local Apps -->
    <div class="section">
        <h2>Installed Apps</h2>
        <button onclick="refreshApps()">Refresh App List</button>
        <div id="apps"></div>
    </div>

    <!-- Remote Apps -->
    <div class="section">
        <h2>Remote Repository</h2>
        <button onclick="listRemoteApps()">List Remote Apps</button>
        <div id="remote_apps"></div>
    </div>

    <script>
        // ===== AUTH HANDLING =====
        const AUTH_TOKEN = localStorage.getItem("AUTH_TOKEN");

        if (!AUTH_TOKEN) {
            window.location.href = "/login";
        }

        function logout() {
            localStorage.removeItem("AUTH_TOKEN");
            window.location.href = "/login";
        }

        function goToNginx() {
            window.location.href = "/nginx";
        }

        async function authFetch(url, options = {}) {
            options.headers = {
                ...(options.headers || {}),
                "Authorization": `Bearer ${AUTH_TOKEN}`,
                "Content-Type": options.headers?.["Content-Type"] || "application/json"
            };

            const res = await fetch(url, options);

            if (res.status === 401 || res.status === 403) {
                alert("Session expired or invalid token. Please log in again.");
                logout();
                return Promise.reject("Unauthorized");
            }

            return res;
        }

        // ===== SYSTEM STATUS =====
        async function refreshSystemStatus() {
            try {
                const res = await authFetch('/system/status');
                const data = await res.json();

                // CPU
                document.getElementById('cpu-text').textContent = `${data.cpu_usage_percent}%`;
                updateProgressBar('cpu-bar', data.cpu_usage_percent);

                // Memory
                document.getElementById('memory-text').textContent = `${data.memory_usage_percent}%`;
                document.getElementById('memory-details').textContent =
                    `Used: ${data.used_memory_gb} GB / Total: ${data.total_memory_gb} GB`;
                updateProgressBar('memory-bar', data.memory_usage_percent);

                // Storage
                document.getElementById('storage-text').textContent = `${data.storage_usage_percent}%`;
                document.getElementById('storage-details').textContent =
                    `Used: ${data.used_storage_gb} GB / Total: ${data.total_storage_gb} GB`;
                updateProgressBar('storage-bar', data.storage_usage_percent);

            } catch {
                document.getElementById('cpu-text').textContent = '--%';
                document.getElementById('memory-text').textContent = '--%';
                document.getElementById('storage-text').textContent = '--%';
            }
        }

        function updateProgressBar(id, value) {
            const bar = document.getElementById(id);
            bar.style.width = `${value}%`;
            bar.classList.remove('warning', 'danger');
            if (value > 80) bar.classList.add('danger');
            else if (value > 60) bar.classList.add('warning');
        }

        setInterval(refreshSystemStatus, 5000);
        refreshSystemStatus();

        // ===== LOCAL APPS =====
        async function refreshApps() {
            const res = await authFetch(`/apps`);
            const data = await res.json();
            const appsDiv = document.getElementById('apps');
            appsDiv.innerHTML = '';
            for (const app of data.apps) {
                const appDiv = document.createElement('div');
                appDiv.className = 'app';
                appDiv.id = `app-${app}`;
                appDiv.innerHTML = `
                    <strong>${app}</strong> 
                    <span id="status-${app}">Loading...</span>
                    <div>
                        <button onclick="startApp('${app}')">Start</button>
                        <button onclick="stopApp('${app}')">Stop</button>
                        <button onclick="getStatus('${app}')">Status</button>
                        <button onclick="pullApp('${app}')">Pull</button>
                    </div>
                    <div id="usage-${app}"></div>
                `;
                appsDiv.appendChild(appDiv);
                getStatus(app);
            }
        }

        async function startApp(app) {
            await authFetch(`/apps/${app}/start`, { method: 'POST' });
            getStatus(app);
        }

        async function stopApp(app) {
            await authFetch(`/apps/${app}/stop`, { method: 'POST' });
            getStatus(app);
        }

        async function getStatus(app) {
            const res = await authFetch(`/apps/${app}/status`);
            const data = await res.json();
            const statusSpan = document.getElementById(`status-${app}`);
            const usageDiv = document.getElementById(`usage-${app}`);

            if (data.running) {
                statusSpan.textContent = 'Running';
                statusSpan.className = 'running';
                if (data.usage) {
                    usageDiv.textContent = `CPU: ${data.usage.cpu_percent.toFixed(2)}% | Memory: ${data.usage.memory_mb.toFixed(2)} MB`;
                } else {
                    usageDiv.textContent = '';
                }
            } else {
                statusSpan.textContent = 'Stopped';
                statusSpan.className = 'stopped';
                usageDiv.textContent = '';
            }
        }

        async function pullApp(app) {
            const res = await authFetch(`/apps/${app}/pull`, { method: 'POST' });
            const data = await res.json();
            alert(data.message || data.error || `Pull request for ${app} completed.`);
            refreshApps();
        }

        setInterval(() => {
            const appsDiv = document.getElementById('apps');
            if (appsDiv.children.length > 0) {
                for (let child of appsDiv.children) {
                    const app = child.id.replace('app-', '');
                    getStatus(app);
                }
            }
        }, 5000);

        // ===== REMOTE APPS =====
        async function listRemoteApps() {
            const res = await authFetch(`/remote_apps`);
            const data = await res.json();
            const remoteDiv = document.getElementById('remote_apps');
            remoteDiv.innerHTML = '';

            if (data.remote_apps) {
                for (const app of data.remote_apps) {
                    const appDiv = document.createElement('div');
                    appDiv.className = 'remote-app';
                    appDiv.innerHTML = `
                        <strong>${app}</strong>
                        <button onclick="cloneApp('${app}')">Clone</button>
                    `;
                    remoteDiv.appendChild(appDiv);
                }
            } else if (data.error) {
                remoteDiv.textContent = "Error: " + data.error;
            }
        }

        async function cloneApp(app) {
            const res = await authFetch(`/apps/${app}/clone`, {
                method: 'POST',
                body: JSON.stringify({ repo_url: '' })
            });
            const data = await res.json();
            alert(data.message || data.error);
            refreshApps();
        }

        refreshApps();
    </script>
</body>
</html>
