<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>App Manager</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        h1, h2 { color: #333; }
        .section { margin-bottom: 30px; }
        .app, .remote-app { border: 1px solid #ccc; padding: 10px; margin-bottom: 10px; border-radius: 5px; }
        button { margin-right: 5px; padding: 5px 10px; }
        .running { color: green; font-weight: bold; }
        .stopped { color: red; font-weight: bold; }
        #system_status { margin-bottom: 20px; }
        .top-bar {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .logout-btn {
            background-color: #dc3545;
            color: white;
            border: none;
            padding: 6px 12px;
            border-radius: 5px;
            cursor: pointer;
        }
        .logout-btn:hover {
            background-color: #b02a37;
        }
    </style>
</head>
<body>
    <div class="top-bar">
        <h1>App Manager Dashboard</h1>
        <button class="logout-btn" onclick="logout()">Logout</button>
    </div>

    <!-- System Status -->
    <div id="system_status" class="section">
        <strong>System Status:</strong> <span id="cpu">CPU: --%</span>, <span id="memory">Memory: --%</span>
    </div>

    <!-- Local Apps -->
    <div class="section">
        <h2>Installed Apps</h2>
        <button onclick="refreshApps()">Refresh App List</button>
        <div id="apps"></div>
    </div>

    <!-- Remote Apps -->
    <div class="section">
        <h2>Remote Repository</h2>
        <button onclick="listRemoteApps()">List Remote Apps</button>
        <div id="remote_apps"></div>
    </div>

    <script>
        // ===== AUTH HANDLING =====
        const AUTH_TOKEN = localStorage.getItem("AUTH_TOKEN");

        if (!AUTH_TOKEN) {
            // Redirect if not logged in
            window.location.href = "/login";
        }

        function logout() {
            localStorage.removeItem("AUTH_TOKEN");
            window.location.href = "/login";
        }

        async function authFetch(url, options = {}) {
            options.headers = {
                ...(options.headers || {}),
                "Authorization": `Bearer ${AUTH_TOKEN}`,
                "Content-Type": options.headers?.["Content-Type"] || "application/json"
            };

            const res = await fetch(url, options);

            // If token expired or invalid, redirect to login
            if (res.status === 401 || res.status === 403) {
                alert("Session expired or invalid token. Please log in again.");
                logout();
                return Promise.reject("Unauthorized");
            }

            return res;
        }

        // ===== SYSTEM STATUS =====
        async function refreshSystemStatus() {
            try {
                const res = await authFetch('/system/status');
                const data = await res.json();
                document.getElementById('cpu').textContent = `CPU: ${data.cpu_usage_percent}%`;
                document.getElementById('memory').textContent = `Memory: ${data.memory_usage_percent}%`;
            } catch {
                document.getElementById('cpu').textContent = `CPU: --%`;
                document.getElementById('memory').textContent = `Memory: --%`;
            }
        }

        setInterval(refreshSystemStatus, 5000);
        refreshSystemStatus();

        // ===== LOCAL APPS =====
        async function refreshApps() {
            const res = await authFetch(`/apps`);
            const data = await res.json();
            const appsDiv = document.getElementById('apps');
            appsDiv.innerHTML = '';
            for (const app of data.apps) {
                const appDiv = document.createElement('div');
                appDiv.className = 'app';
                appDiv.id = `app-${app}`;
                appDiv.innerHTML = `
                    <strong>${app}</strong> 
                    <span id="status-${app}">Loading...</span>
                    <div>
                        <button onclick="startApp('${app}')">Start</button>
                        <button onclick="stopApp('${app}')">Stop</button>
                        <button onclick="getStatus('${app}')">Status</button>
                        <button onclick="pullApp('${app}')">Pull</button>
                    </div>
                    <div id="usage-${app}"></div>
                `;
                appsDiv.appendChild(appDiv);
                getStatus(app);
            }
        }

        async function startApp(app) {
            await authFetch(`/apps/${app}/start`, { method: 'POST' });
            getStatus(app);
        }

        async function stopApp(app) {
            await authFetch(`/apps/${app}/stop`, { method: 'POST' });
            getStatus(app);
        }

        async function getStatus(app) {
            const res = await authFetch(`/apps/${app}/status`);
            const data = await res.json();
            const statusSpan = document.getElementById(`status-${app}`);
            const usageDiv = document.getElementById(`usage-${app}`);

            if (data.running) {
                statusSpan.textContent = 'Running';
                statusSpan.className = 'running';
                if (data.usage) {
                    usageDiv.textContent = `CPU: ${data.usage.cpu_percent.toFixed(2)}% | Memory: ${data.usage.memory_mb.toFixed(2)} MB`;
                } else {
                    usageDiv.textContent = '';
                }
            } else {
                statusSpan.textContent = 'Stopped';
                statusSpan.className = 'stopped';
                usageDiv.textContent = '';
            }
        }

        async function pullApp(app) {
            const res = await authFetch(`/apps/${app}/pull`, { method: 'POST' });
            const data = await res.json();
            alert(data.message || data.error || `Pull request for ${app} completed.`);
            refreshApps();
        }

        // Auto-refresh local app statuses
        setInterval(() => {
            const appsDiv = document.getElementById('apps');
            if (appsDiv.children.length > 0) {
                for (let child of appsDiv.children) {
                    const app = child.id.replace('app-', '');
                    getStatus(app);
                }
            }
        }, 5000);

        // ===== REMOTE APPS =====
        async function listRemoteApps() {
            const res = await authFetch(`/remote_apps`);
            const data = await res.json();
            const remoteDiv = document.getElementById('remote_apps');
            remoteDiv.innerHTML = '';

            if (data.remote_apps) {
                for (const app of data.remote_apps) {
                    const appDiv = document.createElement('div');
                    appDiv.className = 'remote-app';
                    appDiv.innerHTML = `
                        <strong>${app}</strong>
                        <button onclick="cloneApp('${app}')">Clone</button>
                    `;
                    remoteDiv.appendChild(appDiv);
                }
            } else if (data.error) {
                remoteDiv.textContent = "Error: " + data.error;
            }
        }

        async function cloneApp(app) {
            const res = await authFetch(`/apps/${app}/clone`, {
                method: 'POST',
                body: JSON.stringify({ repo_url: '' })  // handled in backend
            });
            const data = await res.json();
            alert(data.message || data.error);
            refreshApps();
        }

        // Initial load
        refreshApps();
    </script>
</body>
</html>
